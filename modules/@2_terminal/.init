#!/usr/bin/env sh

TERMINALM_HOME="$(dirname "$0")"

LOG_NAMESPACE=" @terminal"
LOG_LEVEL=info

##
## Load local/secret environment variables
##

dotenv_path="$TERMINALM_HOME/.env"
if [ -f "$dotenv_path" ]; then
  . "$dotenv_path"
fi

##
## Upgrade dependencies. Coordinated by the HMVC system via global 
## $HMVC_SHOULD_UPGRADE variable.
##

export TERMINALM_LOCAL="${TERMINALM_HOME}/.local"
mkdir -p "$TERMINALM_LOCAL"

zsh_plugins="Aloxaf/fzf-tab
zsh-users/zsh-syntax-highlighting
zsh-users/zsh-autosuggestions
zsh-users/zsh-history-substring-search"

if [ -n "$HMVC_SHOULD_UPGRADE" ] || [ ! -e "$TERMINALM_LOCAL/fzf-tab" ]; then
  fancy-log info "Upgrading ZSH plugins..."

  while IFS= read -r git_address; do
    name=$(basename "$git_address")

    git-download "$git_address" "$TERMINALM_LOCAL/$name"
  done <<EOF
$zsh_plugins
EOF
fi

##
## ZSH
##

ZSHM_HOME="$TERMINALM_HOME/config/zsh"

. "${ZSHM_HOME}/config"
. "${ZSHM_HOME}/aliases"
. "${ZSHM_HOME}/plugins"
. "${ZSHM_HOME}/vars"

# ╭───┤ Link user configs 
# ╰─

while IFS="" read -r dir; do
  fake="$HOME/.config/$dir"
  real="$TERMINALM_HOME/config/$dir"
  ensure_symlink "$real" "$fake"
done << EOF
alacritty
bat
neofetch
starship
EOF

## Starship

# Default config is ~/.config/starship.toml
export STARSHIP_CONFIG="$HOME/.config/starship/config.toml"
eval "$(starship init zsh)"

## BAT

export BAT_THEME="gruvbox-dark"

